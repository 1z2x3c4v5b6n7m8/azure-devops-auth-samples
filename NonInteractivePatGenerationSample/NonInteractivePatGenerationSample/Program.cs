using Microsoft.IdentityModel.Clients.ActiveDirectory;
using Microsoft.VisualStudio.Services.Client;
using Microsoft.VisualStudio.Services.DelegatedAuthorization;
using Microsoft.VisualStudio.Services.DelegatedAuthorization.Client;
using Microsoft.VisualStudio.Services.WebApi;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace NonInteractivePatGenerationSample
{
    public class Program
    {
        // This is the resource ID for the VSTS application - don't change this.
        private const string VstsResourceId = "499b84ac-1321-427f-aa17-267ca6975798";

        // This is the resource for your own application registered in AAD (which needs access to the VSTS application).
        private const string ClientId = "[your AAD application client ID]";

        public static void Main(string[] args)
        {
            var adalCredential = new UserPasswordCredential(
                "[your AAD username]", // 
                "[your AAD password]"
                );

            var authenticationContext = new AuthenticationContext("https://login.microsoftonline.com/common");
            var result = authenticationContext.AcquireTokenAsync(VstsResourceId, ClientId, adalCredential).Result;

            var token = new VssAadToken(result);
            var vstsCredential = new VssAadCredential(token);

            var connection = new VssConnection(new Uri("https://[your VSTS account name].visualstudio.com"), vstsCredential);
            var client = connection.GetClient<DelegatedAuthorizationHttpClient>();

            var pat = client.CreateSessionToken(
                displayName: "Generated by sample code",
                tokenType: SessionTokenType.Compact,
                scope: "vso.work"
                ).Result;

            Console.WriteLine(pat.Token);
        }
    }
}
